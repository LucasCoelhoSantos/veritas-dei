<div class="container-xl d-flex flex-column py-5" style="height: 80vh;">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between">
        <div class="d-flex align-items-center">
          <div class="bg-primary bg-gradient rounded-circle p-3 me-3 shadow-sm">
            <i class="bi bi-feather text-white fs-4"></i>
          </div>
          <div>
            <h2 class="mb-0 fw-bold">IA Veritas Dei</h2>
            <p class="text-muted fs-6 mb-0">Assistente Católico</p>
          </div>
        </div>
        <div>
          <span class="badge bg-info-subtle text-dark shadow-sm">
            {{ contadorPerguntas() }} perguntas restantes
          </span>
        </div>
      </div>
    </div>
  </div>

  <div class="row flex-grow-1">
    <div class="col-12">
      <div class="card h-100 shadow-lg rounded-4 border-0">
        <div class="card-body d-flex flex-column p-0" style="height: 70vh;">
          <div #chatArea class="flex-grow-1 overflow-auto p-4">
            <!-- Loop de mensagens -->
             <ng-container *ngFor="let mensagem of mensagens(); trackBy: trackByTimestamp">
              
              <!-- Mensagem IA -->
              <div *ngIf="mensagem.n8nResponse" class="d-flex align-items-start mb-4">
                <div class="bg-light rounded-circle p-2 me-3 shadow-sm">
                  <i class="bi bi-robot text-primary"></i>
                </div>
                <div class="flex-grow-1">
                  <div class="bg-light-subtle border rounded-4 p-3 shadow-sm mb-2" [innerHTML]="formatarConteudo(mensagem.response.message)"></div>
                  
                  <div class="d-flex gap-2 mt-1">
                    <button class="btn btn-sm btn-outline-primary rounded-pill" (click)="copiarMensagem(mensagem.response.message)">
                      <i class="bi bi-clipboard"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary rounded-pill" (click)="compartilharMensagem(mensagem.response.message)">
                      <i class="bi bi-share"></i>
                    </button>
                  </div>

                  <div *ngIf="mensagem.response.references?.length" class="mt-2">
                    <small class="text-muted d-block mb-1">Fontes:</small>
                    <div class="d-flex flex-wrap gap-1">
                      <ng-container *ngFor="let ref of mensagem.response.references">
                        <span *ngIf="ehString(ref)" class="badge bg-secondary-subtle text-dark">{{ ref }}</span>
                        <a *ngIf="!ehString(ref)" [href]="ref.url" target="_blank" class="badge bg-secondary-subtle text-dark text-decoration-none">
                          {{ ref.title }}
                        </a>
                      </ng-container>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Mensagem Usuário -->
              <div *ngIf="!mensagem.n8nResponse" class="d-flex align-items-start justify-content-end mb-4">
                <div class="flex-grow-1 text-end">
                  <div class="bg-primary text-white rounded-4 p-3 shadow-sm d-inline-block">
                    {{ mensagem.response.message }}
                  </div>
                </div>
                <div class="bg-primary rounded-circle p-2 ms-3 shadow-sm">
                  <i class="bi bi-person text-white"></i>
                </div>
              </div>

            </ng-container>

            <!-- Mensagem enviando -->
            <div *ngIf="enviando()" class="d-flex align-items-start mb-4">
              <div class="bg-light rounded-circle p-2 me-3 shadow-sm">
                <i class="bi bi-robot text-primary"></i>
              </div>
              <div class="bg-light-subtle border rounded-4 p-3 shadow-sm d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                <span class="text-muted">Pensando...</span>
              </div>
            </div>
          </div>

          <div class="border-top p-3">
            <div class="input-group">
              <input type="text" class="form-control" placeholder="Faça sua pergunta sobre a fé católica..."
                     [(ngModel)]="novaPergunta" (keydown.enter)="enviarMensagem()"
                     [disabled]="enviando() || contadorPerguntas() <= 0">
              <button class="btn btn-primary" type="button" (click)="enviarMensagem()"
                      [disabled]="!novaPergunta.trim() || enviando() || contadorPerguntas() <= 0">
                <i class="bi bi-send"></i>
              </button>
            </div>

            <div *ngIf="contadorPerguntas() <= 0" class="alert alert-warning mt-3 mb-0 rounded-4 shadow-sm">
              <i class="bi bi-exclamation-triangle me-2"></i>
              Você não tem mais perguntas disponíveis. 
              <a href="/pagar" class="alert-link">Assine um plano</a> para continuar.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
